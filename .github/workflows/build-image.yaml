name: Build Kong Gateway Image

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to provision'
        type: choice
        options:
          - 'dev'
          - 'tst'
          - 'acc'
          - 'prd'
        default: 'dev'
      docker_registry:
        description: 'Docker registry'
        type: string
        default: localhost:5000
      image_repo:
        description: 'Docker image repository'
        type: string
        default: myrepo/kong
      image_tag:
        description: 'Docker image tag'
        type: string
      kong_version:
        description: 'Kong Gateway version'
        type: string
        default: "3.11.0.0"
      continue_on_scan_failure:
        description: 'Continue on Trivy scan failure'
        default: true
        type: boolean

jobs:
  build-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Image
        uses: ./.github/actions/build-image
        with:
          docker_registry: ${{ inputs.docker_registry }}
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          vault_token: ${{ secrets.VAULT_TOKEN }}
          image_tag: ${{ inputs.image_tag }}
          image_repo: ${{ inputs.image_repo }}
          kong_version: ${{ inputs.kong_version }}
          continue_on_scan_failure: ${{ inputs.continue_on_scan_failure }}
          environment: ${{ inputs.environment }}